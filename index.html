<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Psychoinformatics API Frontend</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">Psychoinformatics API Frontend</h1>
    
    <!-- 使用 Grid 分成三個區塊 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      
      <!-- 區塊 1: /terms -->
      <div class="bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">1. Get All Terms</h2>
        <button id="btn_terms" 
                class="bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded p-3 w-full transition duration-200 mb-4">
          Fetch All Terms
        </button>
        <pre id="out_terms" 
             class="bg-white p-4 rounded border border-gray-300 shadow-inner text-xs overflow-auto max-h-96">
          點擊按鈕以載入資料...
        </pre>
      </div>

      <!-- 區塊 2: /terms/<t1> -->
      <div class="bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">2. Get Term by &lt;t1&gt; <span class="text-sm text-gray-500">(即時搜尋)</span></h2>
        <input type="text" 
               id="input_t1" 
               placeholder="Enter term (e.g., amygdala)"
               class="w-full p-3 border border-gray-300 rounded mb-3 focus:outline-none focus:ring-2 focus:ring-green-500">
        <pre id="out_t1" 
             class="bg-white p-4 rounded border border-gray-300 shadow-inner text-xs overflow-auto max-h-96">
          開始輸入以即時搜尋...
        </pre>
      </div>

      <!-- 區塊 3: /query/<q_string>/studies -->
      <div class="bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">3. Query Studies <span class="text-sm text-gray-500">(即時搜尋)</span></h2>
        <input type="text" 
               id="input_query" 
               placeholder="Enter query (e.g., amygdala not emotion)"
               class="w-full p-3 border border-gray-300 rounded mb-3 focus:outline-none focus:ring-2 focus:ring-purple-500">
        <pre id="out_query" 
             class="bg-white p-4 rounded border border-gray-300 shadow-inner text-xs overflow-auto max-h-96">
          開始輸入以即時搜尋...
        </pre>
      </div>

    </div>
  </div>

  <script>
    // API 基礎網址 (使用替代伺服器)
    const BASE_URL = 'https://hpc.psy.ntu.edu.tw:5000';

    // Debounce 函式:避免在使用者快速打字時發送過多請求
    function debounce(func, delay) {
      let timeoutId;
      return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
      };
    }

    // 功能 1: 查詢所有術語
    async function fetchAllTerms() {
      const out = document.getElementById('out_terms');
      out.textContent = '正在請求資料...';
      
      try {
        const resp = await fetch(`${BASE_URL}/terms`);
        let info = `HTTP ${resp.status} ${resp.statusText}\n\n`;

        if (!resp.ok) {
          const text = await resp.text();
          out.textContent = info + text;
          return;
        }

        const data = await resp.json();
        out.textContent = info + JSON.stringify(data, null, 2);
      } catch (err) {
        out.textContent = 
          'Error: ' + (err && err.message ? err.message : String(err)) +
          '\n\n常見原因:\n1) 伺服器未允許 CORS\n2) 使用 file:// 而非本地伺服器開啟\n3) 網路或伺服器問題';
      }
    }

    // 功能 2: 查詢單一術語 (即時搜尋)
    async function fetchSingleTerm() {
      const t1 = document.getElementById('input_t1').value.trim();
      const out = document.getElementById('out_t1');

      if (!t1) {
        out.textContent = '開始輸入以即時搜尋...';
        return;
      }

      out.textContent = '正在請求資料...';
      
      try {
        const resp = await fetch(`${BASE_URL}/terms/${t1}`);
        let info = `HTTP ${resp.status} ${resp.statusText}\n\n`;

        if (!resp.ok) {
          const text = await resp.text();
          out.textContent = info + text;
          return;
        }

        const data = await resp.json();
        out.textContent = info + JSON.stringify(data, null, 2);
      } catch (err) {
        out.textContent = 
          'Error: ' + (err && err.message ? err.message : String(err)) +
          '\n\n常見原因:\n1) 伺服器未允許 CORS\n2) 使用 file:// 而非本地伺服器開啟\n3) 網路或伺服器問題';
      }
    }

    // 功能 3: 查詢研究 (即時搜尋)
    async function searchStudies() {
      const q_string = document.getElementById('input_query').value.trim();
      const out = document.getElementById('out_query');

      if (!q_string) {
        out.textContent = '開始輸入以即時搜尋...';
        return;
      }

      out.textContent = '正在請求資料...';
      
      try {
        // 使用 encodeURIComponent 處理特殊字元
        const encodedQuery = encodeURIComponent(q_string);
        const resp = await fetch(`${BASE_URL}/query/${encodedQuery}/studies`);
        let info = `HTTP ${resp.status} ${resp.statusText}\n\n`;

        if (!resp.ok) {
          const text = await resp.text();
          out.textContent = info + text;
          return;
        }

        const data = await resp.json();
        out.textContent = info + JSON.stringify(data, null, 2);
      } catch (err) {
        out.textContent = 
          'Error: ' + (err && err.message ? err.message : String(err)) +
          '\n\n常見原因:\n1) 伺服器未允許 CORS\n2) 使用 file:// 而非本地伺服器開啟\n3) 網路或伺服器問題';
      }
    }

    // 建立 debounced 版本的函式 (延遲 500ms)
    const debouncedFetchTerm = debounce(fetchSingleTerm, 500);
    const debouncedSearchStudies = debounce(searchStudies, 500);

    // 綁定事件監聽器
    document.getElementById('btn_terms').addEventListener('click', fetchAllTerms);
    
    // 即時搜尋:監聽 input 事件
    document.getElementById('input_t1').addEventListener('input', debouncedFetchTerm);
    document.getElementById('input_query').addEventListener('input', debouncedSearchStudies);
  </script>
</body>
</html>

